<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiobook Narrator Search v1.2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.2rem;
            background: linear-gradient(90deg, #e94560, #f5a623);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-badge {
            font-size: 0.7rem;
            color: #6b7280;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 10px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }

        .subtitle {
            color: #8892a0;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            outline: none;
        }

        .search-input::placeholder {
            color: #6b7280;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.3);
        }

        .search-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #e94560, #f5a623);
            color: #fff;
            cursor: pointer;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .source-progress {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .source-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            color: #6b7280;
        }

        .source-status.searching {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            animation: pulse 1.5s infinite;
        }

        .source-status.found {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .source-status.not-found {
            background: rgba(239, 68, 68, 0.1);
            color: #6b7280;
            text-decoration: line-through;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .result-card {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-card.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .profile-header {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .profile-info {
            flex: 1;
        }

        .narrator-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .narrator-tagline {
            color: #f5a623;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .source-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .source-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(233, 69, 96, 0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            color: #e94560;
        }

        .profile-body {
            padding: 2rem;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #f5a623;
        }

        .bio-text {
            line-height: 1.8;
            color: #c8c8c8;
            white-space: pre-line;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #a8a8a8;
        }

        .tag.award {
            background: rgba(245, 166, 35, 0.15);
            color: #f5a623;
        }

        .sources-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sources-section h4 {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            color: #6b7280;
        }

        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .source-link {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.8rem;
            color: #8892a0;
            text-decoration: none;
        }

        .source-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e94560;
        }

        /* Selection sections */
        .selection-section {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selection-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #f5a623;
        }

        .image-options {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .image-option {
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            background: #000;
        }

        .image-option:hover {
            border-color: rgba(233, 69, 96, 0.5);
        }

        .image-option.selected {
            border-color: #e94560;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.4);
        }

        .image-option img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .image-option-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 0.5rem;
            font-size: 0.7rem;
        }

        .image-option-source {
            color: #f5a623;
            font-weight: 600;
        }

        .image-option-score {
            color: #888;
        }

        .image-option-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #e94560;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .image-option.selected .image-option-check {
            display: flex;
        }

        .bio-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .bio-option {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bio-option:hover {
            border-color: rgba(233, 69, 96, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .bio-option.selected {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }

        .bio-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .bio-option-source {
            color: #f5a623;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .bio-option-length {
            color: #666;
            font-size: 0.75rem;
        }

        .bio-option-text {
            color: #c8c8c8;
            font-size: 0.9rem;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .bio-option.selected .bio-option-text {
            -webkit-line-clamp: unset;
        }

        .bio-option-check {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bio-option.selected .bio-option-check {
            background: #e94560;
            border-color: #e94560;
            color: white;
        }

        /* Export section */
        .export-section {
            padding: 1.5rem 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #f5a623;
        }

        #exportData {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #a8a8a8;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .export-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #e94560, #f5a623);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        .firebase-btn {
            margin-top: 1rem;
            margin-left: 1rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .firebase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .firebase-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .firebase-btn.uploading {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .firebase-btn.success {
            background: linear-gradient(135deg, #4CAF50, #2e7d32);
        }

        .firebase-btn.error {
            background: linear-gradient(135deg, #f44336, #c62828);
        }

        .firebase-status {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: none;
        }

        .firebase-status.show {
            display: block;
        }

        .firebase-status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
        }

        .firebase-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #e57373;
        }

        .no-image-option {
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            color: #888;
        }

        .no-image-option span {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .custom-image-option {
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(233, 69, 96, 0.1);
            color: #e94560;
            border: 2px dashed rgba(233, 69, 96, 0.3);
            border-radius: 8px;
        }

        .custom-input-container {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(233, 69, 96, 0.3);
        }

        .custom-input-container label {
            display: block;
            margin-bottom: 0.5rem;
            color: #f5a623;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .custom-input-container input,
        .custom-input-container textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .custom-image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 0.75rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .tab-btn.active {
            background: rgba(233, 69, 96, 0.2);
            border-color: #e94560;
            color: #e94560;
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            color: #888;
        }

        .error-message {
            display: none;
            text-align: center;
            padding: 2rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            margin-bottom: 1rem;
        }

        .error-message.active {
            display: block;
        }

        .suggestions {
            margin-top: 2rem;
            text-align: center;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .suggestion-chip {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #a8a8a8;
            cursor: pointer;
        }

        .debug-panel {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #6b7280;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 600px) {
            .profile-header { flex-direction: column; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéß Narrator Lookup</h1>
            <div class="version-badge">Build: v1.2.0</div>
            <p class="subtitle">Search multiple sources for audiobook narrator profiles</p>
        </header>

        <div class="search-container">
            <input type="text" class="search-input" id="narratorInput" 
                   placeholder="Enter narrator name (e.g., Simon Vance)" autocomplete="off">
            <button class="search-btn" id="searchBtn">Search</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching narrator databases...</p>
            <div class="source-progress" id="sourceProgress"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="result-card" id="resultCard">
            <div class="profile-header">
                <div class="profile-info">
                    <h2 class="narrator-name" id="narratorName"></h2>
                    <p class="narrator-tagline" id="narratorTagline"></p>
                    <div class="source-badges" id="sourceBadges"></div>
                </div>
            </div>
            
            <div class="selection-section" id="imageSelectionSection">
                <h3>üì∑ Select Profile Image</h3>
                <div class="image-options" id="imageOptions"></div>
                <div class="custom-input-container" id="customImageInput" style="display: none;">
                    <label>Custom Image:</label>
                    <div style="margin-bottom: 0.75rem;">
                        <button type="button" class="tab-btn active" onclick="switchImageTab('url')">URL</button>
                        <button type="button" class="tab-btn" onclick="switchImageTab('upload')">Upload</button>
                    </div>
                    <div id="imageUrlTab">
                        <input type="text" id="customImageUrl" placeholder="https://example.com/image.jpg" oninput="updateExportData()">
                    </div>
                    <div id="imageUploadTab" style="display: none;">
                        <div class="file-upload-area" onclick="document.getElementById('imageFileInput').click()">
                            <span>Click to upload or drag & drop</span>
                        </div>
                        <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    <div class="custom-image-preview" id="customImagePreview"></div>
                </div>
            </div>
            
            <div class="selection-section" id="bioSelectionSection">
                <h3>üìù Select Biography</h3>
                <div class="bio-options" id="bioOptions"></div>
                <div class="custom-input-container" id="customBioInput" style="display: none;">
                    <label>Custom Biography:</label>
                    <textarea id="customBioText" placeholder="Write a custom biography..." rows="4" oninput="updateExportData()"></textarea>
                </div>
            </div>

            <div class="profile-body">
                <div class="section" id="awardsSection">
                    <h3>üèÜ Awards</h3>
                    <div class="tags-list" id="awardsList"></div>
                </div>
                <div class="section" id="accentsSection">
                    <h3>üó£Ô∏è Accents</h3>
                    <div class="tags-list" id="accentsList"></div>
                </div>
                <div class="section" id="genresSection">
                    <h3>üé≠ Genres</h3>
                    <div class="tags-list" id="genresList"></div>
                </div>
                <div class="section" id="worksSection">
                    <h3>üìö Notable Audiobooks</h3>
                    <div class="tags-list" id="worksList"></div>
                </div>
                <div class="sources-section">
                    <h4>Sources</h4>
                    <div class="sources-list" id="sourcesList"></div>
                </div>
            </div>
            
            <div class="export-section">
                <h3>üì§ Selected Data</h3>
                <pre id="exportData"></pre>
                <div style="display: flex; flex-wrap: wrap; align-items: center;">
                    <button class="export-btn" id="copyBtn">Copy JSON</button>
                    <button class="firebase-btn" id="firebaseBtn" onclick="uploadToFirebase()">üî• Upload to Firebase</button>
                </div>
                <div class="firebase-status" id="firebaseStatus"></div>
            </div>
        </div>

        <div class="suggestions" id="suggestions">
            <p>Try searching for popular narrators:</p>
            <div class="suggestion-chips">
                <span class="suggestion-chip" data-narrator="Simon Vance">Simon Vance</span>
                <span class="suggestion-chip" data-narrator="Julia Whelan">Julia Whelan</span>
                <span class="suggestion-chip" data-narrator="Ray Porter">Ray Porter</span>
                <span class="suggestion-chip" data-narrator="RC Bray">RC Bray</span>
                <span class="suggestion-chip" data-narrator="Travis Baldree">Travis Baldree</span>
            </div>
        </div>

        <div class="debug-panel" id="debugLog"></div>
    </div>

    <script>
        const APP_VERSION = "1.2.0";
        console.log(`LitLyric Narrator Lookup Initialized - Version ${APP_VERSION}`);

        const SOURCES = {
            audible: { name: 'Audible', icon: 'üéß' },
            wikipedia: { name: 'Wikipedia', icon: 'üìñ' },
            audiofile: { name: 'AudioFile', icon: 'üì∞' },
            voicestoknow: { name: 'Voices to Know', icon: 'üé§' },
            soundbooth: { name: 'Soundbooth', icon: 'üé≠' },
            tantor: { name: 'Tantor', icon: 'üìö' },
            imdb: { name: 'IMDB', icon: 'üé¨' },
            google: { name: 'Google', icon: 'üîç' },
            soundcloud: { name: 'SoundCloud', icon: '‚òÅÔ∏è' }
        };

        const searchInput = document.getElementById('narratorInput');
        const searchBtn = document.getElementById('searchBtn');
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');
        const errorMessage = document.getElementById('errorMessage');
        const suggestions = document.getElementById('suggestions');
        const sourceProgress = document.getElementById('sourceProgress');
        const debugLog = document.getElementById('debugLog');

        let currentData = null;

        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                searchInput.value = chip.dataset.narrator;
                performSearch();
            });
        });

        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        searchBtn.addEventListener('click', performSearch);

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.color = type === 'error' ? '#ef4444' : (type === 'success' ? '#22c55e' : '#6b7280');
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function nameToSlug(name) { return name.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/--+/g, '-').trim(); }

        async function fetchViaProxy(url) {
            const proxies = [
                u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
            ];
            for (const proxy of proxies) {
                try {
                    const res = await fetch(proxy(url));
                    if (res.ok) return await res.text();
                } catch (e) { continue; }
            }
            throw new Error('CORS proxies failed');
        }

        function stripHtml(html) { return html.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim(); }

        function cleanBio(bio, name) {
            if (!bio) return "";
            let cleaned = bio.trim();
            const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`^${escapedName}[,.:;]?\\s*`, 'i');
            cleaned = cleaned.replace(regex, '');
            return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
        }

        function scoreImage(imageUrl, source) {
            if (!imageUrl) return 0;
            let score = 0;
            const sourceWeights = { imdb: 110, audiofile: 100, voicestoknow: 95, wikipedia: 90, soundcloud: 75, soundbooth: 75, audible: 40, tantor: 35, google: 10 };
            score += sourceWeights[source] || 10;
            const lower = imageUrl.toLowerCase();
            if (lower.includes('/images/m/')) score += 40; // IMDB People directory
            if (lower.includes('/images/i/')) score -= 100; // Amazon/Audible Product directory
            if (lower.includes('headshot') || lower.includes('portrait')) score += 30;
            if (lower.includes('cover') || lower.includes('.aa') || lower.includes('book')) score -= 60;
            return score;
        }

        async function searchWikipedia(name) {
            const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(name.replace(/ /g, '_'))}`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                if (!data.extract.toLowerCase().includes('narrator') && !data.extract.toLowerCase().includes('voice actor')) return null;
                return { source: 'wikipedia', url: data.content_urls.desktop.page, bio: data.extract, imageUrl: data.thumbnail?.source };
            } catch (e) { return null; }
        }

        async function searchIMDB(name) {
            const searchUrl = `https://www.imdb.com/find/?q=${encodeURIComponent(name)}&s=nm`;
            try {
                const html = await fetchViaProxy(searchUrl);
                const match = html.match(/href="(\/name\/nm\d+)\/?"/i);
                if (!match) return null;
                const profileUrl = `https://www.imdb.com${match[1]}/`;
                const profileHtml = await fetchViaProxy(profileUrl);
                const imgMatch = profileHtml.match(/class="[^"]*ipc-image[^"]*"[^>]*src="(https:\/\/m\.media-amazon\.com\/images\/M\/[^"]+)"/i);
                return { source: 'imdb', url: profileUrl, imageUrl: imgMatch ? imgMatch[1].replace(/\._V1_[^.]+\.jpg/, '._V1_UX400.jpg') : null };
            } catch (e) { return null; }
        }

        async function searchAudioFile(name) {
            const url = `https://www.audiofilemagazine.com/narrators/${nameToSlug(name)}/`;
            try {
                const html = await fetchViaProxy(url);
                if (!html.includes('Spotlight')) return null;
                const res = { source: 'audiofile', url, accents: [], genres: [], awards: [] };
                const acc = html.match(/Accents?:\s*([^¬∑<\n]+)/i); if (acc) res.accents = acc[1].split(',').map(s => s.trim());
                const gen = html.match(/Genres?:\s*([^¬∑<\n]+)/i); if (gen) res.genres = gen[1].split(',').map(s => s.trim());
                const img = html.match(/src="([^"]*\/content\/uploaded\/images\/narrators\/[^"]+)"/i); if (img) res.imageUrl = img[1].startsWith('http') ? img[1] : 'https://www.audiofilemagazine.com' + img[1];
                return res;
            } catch (e) { return null; }
        }

        async function performSearch() {
            const name = searchInput.value.trim();
            if (!name) return;
            debugLog.innerHTML = '';
            loading.classList.add('active');
            resultCard.classList.remove('active');
            errorMessage.classList.remove('active');
            searchBtn.disabled = true;
            log(`Starting optimized search v${APP_VERSION} for "${name}"`);

            sourceProgress.innerHTML = Object.entries(SOURCES).map(([k, v]) => `<span class="source-status" id="status-${k}">${v.icon} ${v.name}</span>`).join('');

            try {
                // Tier 1: Fast/High Quality
                const t1 = await Promise.all([
                    searchWikipedia(name),
                    searchIMDB(name),
                    searchAudioFile(name)
                ]);

                // Tier 2: Slower/Fallback
                const results = [...t1];
                const merged = mergeResults(name, results);
                displayResult(merged);
            } catch (e) {
                log(`Search error: ${e.message}`, 'error');
                errorMessage.textContent = "Search failed. Check debug log.";
                errorMessage.classList.add('active');
            } finally {
                loading.classList.remove('active');
                searchBtn.disabled = false;
            }
        }

        function mergeResults(name, results) {
            const filtered = results.filter(r => r !== null);
            const merged = { name, images: [], bios: [], tagline: null, books: [], awards: [], accents: [], genres: [], sources: [], selectedImage: 0, selectedBio: 0 };
            
            filtered.forEach(r => {
                merged.sources.push({ name: r.source, url: r.url });
                if (r.imageUrl) merged.images.push({ url: r.imageUrl, source: r.source, score: scoreImage(r.imageUrl, r.source) });
                if (r.bio) merged.bios.push({ text: cleanBio(r.bio, name), source: r.source, length: r.bio.length });
                if (r.accents) merged.accents = [...new Set([...merged.accents, ...r.accents])];
                if (r.genres) merged.genres = [...new Set([...merged.genres, ...r.genres])];
            });

            merged.images.sort((a, b) => b.score - a.score);
            merged.bios.sort((a, b) => b.length - a.length);
            return merged;
        }

        function displayResult(data) {
            currentData = data;
            document.getElementById('narratorName').textContent = data.name;
            document.getElementById('sourceBadges').innerHTML = data.sources.map(s => `<span class="source-badge">${SOURCES[s.name]?.icon || 'üìÑ'} ${s.name}</span>`).join('');
            
            // Render Images
            const imgOpts = document.getElementById('imageOptions');
            imgOpts.innerHTML = `
                <div class="image-option" onclick="selectImage(null)"><div class="no-image-option"><span>‚úï</span><small>None</small></div></div>
                <div class="image-option" onclick="selectImage('custom')"><div class="custom-image-option"><span>Ôºã</span><small>Custom</small></div></div>
            ` + data.images.map((img, i) => `
                <div class="image-option ${i === 0 ? 'selected' : ''}" onclick="selectImage(${i})">
                    <img src="${img.url}" loading="lazy">
                    <div class="image-option-info"><span class="image-option-source">${img.source}</span></div>
                    <div class="image-option-check">‚úì</div>
                </div>
            `).join('');

            // Render Bios
            const bioOpts = document.getElementById('bioOptions');
            bioOpts.innerHTML = `
                <div class="bio-option" onclick="selectBio('custom')"><div class="bio-option-header"><span class="bio-option-source">Ôºã Custom</span></div><p class="bio-option-text">Create your own biography</p></div>
            ` + data.bios.map((bio, i) => `
                <div class="bio-option ${i === 0 ? 'selected' : ''}" onclick="selectBio(${i})">
                    <div class="bio-option-header"><span class="bio-option-source">${bio.source}</span><span class="bio-option-length">${bio.length} chars</span><div class="bio-option-check"></div></div>
                    <p class="bio-option-text">${bio.text}</p>
                </div>
            `).join('');

            document.getElementById('awardsSection').style.display = 'none';
            document.getElementById('accentsSection').style.display = data.accents.length ? 'block' : 'none';
            document.getElementById('accentsList').innerHTML = data.accents.map(a => `<span class="tag">${a}</span>`).join('');
            document.getElementById('genresSection').style.display = data.genres.length ? 'block' : 'none';
            document.getElementById('genresList').innerHTML = data.genres.map(g => `<span class="tag">${g}</span>`).join('');
            document.getElementById('sourcesList').innerHTML = data.sources.map(s => `<a href="${s.url}" target="_blank" class="source-link">${SOURCES[s.name]?.icon} ${s.name}</a>`).join('');

            updateExportData();
            resultCard.classList.add('active');
        }

        function selectImage(idx) {
            currentData.selectedImage = idx;
            document.querySelectorAll('.image-option').forEach((el, i) => el.classList.toggle('selected', (idx === null && i === 0) || (idx === 'custom' && i === 1) || (idx === i-2)));
            document.getElementById('customImageInput').style.display = idx === 'custom' ? 'block' : 'none';
            updateExportData();
        }

        function selectBio(idx) {
            currentData.selectedBio = idx;
            document.querySelectorAll('.bio-option').forEach((el, i) => el.classList.toggle('selected', (idx === 'custom' && i === 0) || (idx === i-1)));
            document.getElementById('customBioInput').style.display = idx === 'custom' ? 'block' : 'none';
            updateExportData();
        }

        function updateExportData() {
            if (!currentData) return;
            const exp = { name: currentData.name, imageUrl: null, bio: null };
            if (typeof currentData.selectedImage === 'number') exp.imageUrl = currentData.images[currentData.selectedImage].url;
            else if (currentData.selectedImage === 'custom') exp.imageUrl = document.getElementById('customImageUrl').value;
            
            if (typeof currentData.selectedBio === 'number') exp.bio = currentData.bios[currentData.selectedBio].text;
            else if (currentData.selectedBio === 'custom') exp.bio = document.getElementById('customBioText').value;

            document.getElementById('exportData').textContent = JSON.stringify(exp, null, 2);
        }

        function switchImageTab(tab) {
            document.getElementById('imageUrlTab').style.display = tab === 'url' ? 'block' : 'none';
            document.getElementById('imageUploadTab').style.display = tab === 'upload' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === tab));
        }

        function handleFileSelect(e) {
            const reader = new FileReader();
            reader.onload = () => { document.getElementById('customImagePreview').innerHTML = `<img src="${reader.result}">`; currentData.customImageData = reader.result; updateExportData(); };
            reader.readAsDataURL(e.target.files[0]);
        }

        const FIREBASE_CONFIG = { apiKey: "AIzaSyDPKVYX_lPfpPMfwF0ViesSr0YizYZyAX8", authDomain: "litlyric-narrator-batabase.firebaseapp.com", projectId: "litlyric-narrator-batabase", storageBucket: "litlyric-narrator-batabase.firebasestorage.app", messagingSenderId: "312216800042", appId: "1:312216800042:web:9b90057de27703b4b1ac53" };
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        async function uploadToFirebase() {
            const btn = document.getElementById('firebaseBtn');
            btn.disabled = true; btn.textContent = "Uploading...";
            try {
                const docId = currentData.name.toLowerCase().replace(/\s+/g, '-');
                const data = JSON.parse(document.getElementById('exportData').textContent);
                await db.collection('narrators').doc(docId).set(data, { merge: true });
                btn.textContent = "Done!";
                setTimeout(() => btn.textContent = "Upload to Firebase", 2000);
            } catch (e) { btn.textContent = "Error"; }
            btn.disabled = false;
        }

        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('exportData').textContent);
            document.getElementById('copyBtn').textContent = "Copied!";
            setTimeout(() => document.getElementById('copyBtn').textContent = "Copy JSON", 2000);
        });
    </script>
</body>
</html>
